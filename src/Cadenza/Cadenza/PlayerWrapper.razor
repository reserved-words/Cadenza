@using Cadenza.Web.Common.Events
@using Cadenza.Web.Player

<Player Loading="@Loading" 
        Track="@Track" 
        CanSkipNext="@CanSkipNext" 
        OnSkipNext="@OnSkipNext" 
        OnSkipPrevious="@OnSkipPrevious"
        OnTrackStatusChanged="OnTrackStatusChanged" />

@code {
    [Inject]
    public IAppConsumer App { get; set; }

    [Inject]
    public IAppController AppController { get; set; }

    public bool Loading { get; set; }
    public PlayTrack Track { get; set; }
    public bool CanSkipNext { get; set; }

    protected override void OnInitialized()
    {
        App.PlaylistLoading += OnPlaylistLoading;
        App.PlaylistFinished += OnPlaylistFinished;
        App.StartTrack += OnStartTrack;
    }

    private async Task OnSkipNext()
    {
        await AppController.SkipNext();
    }

    private async Task OnSkipPrevious()
    {
        await AppController.SkipPrevious();
    }

    private Task OnPlaylistFinished(object sender, PlaylistEventArgs e)
    {
        Loading = false;
        Track = null;
        CanSkipNext = false;
        StateHasChanged();
        return Task.CompletedTask;
    }

    private Task OnPlaylistLoading(object sender, PlaylistEventArgs e)
    {
        Loading = true;
        Track = null;
        CanSkipNext = false;
        StateHasChanged();
        return Task.CompletedTask;
    }

    //private async Task OnTrackFinished(object sender, TrackEventArgs e)
    //{
    //    if (e.IsLastTrack)
    //    {
    //        Loading = false;
    //        Track = null;
    //        CanSkipNext = false;
    //        StateHasChanged();
    //    }
    //}

    private Task OnStartTrack(object sender, TrackEventArgs e)
    {
        Loading = false;
        Track = e.CurrentTrack;
        CanSkipNext = !e.IsLastTrack;
        StateHasChanged();
        return Task.CompletedTask;
    }

    private async Task OnTrackStatusChanged(TrackStatusEventArgs args)
    {
        await AppController.OnTrackStatusChanged(args);
    }
}
