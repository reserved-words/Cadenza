@inherits FluxorComponent

@using Cadenza.Web.Actions;
@using Cadenza.Web.State.Store;
@using Cadenza.Web.Common.Interfaces.Store
@using IDialogService = Cadenza.Web.Components.Interfaces.IDialogService

<EditCard>

    <AppTable Items="@Model">
        <RowTemplate>
            <MudTd Class="td-int">@context.DiscTrackNo()</MudTd>

            <MudHidden Breakpoint="@Breakpoint.Xs" Invert="true">
                <MudTd>
                    <MudText Typo="@Typo.body1">@context.Title</MudText>
                    <MudText Typo="@Typo.body2">@context.ArtistName</MudText>
                </MudTd>
            </MudHidden>

            <MudHidden Breakpoint="@Breakpoint.Xs" Invert="false">
                <MudTd>@context.Title</MudTd>
                <MudTd>@context.ArtistName</MudTd>
            </MudHidden>

            <MudTd Class="td-int">
                <MudIconButton Size="@Size.Small"
                               Icon="@Icons.Material.Filled.Delete"
                               Variant="@Variant.Outlined"
                               OnClick="@(() => OnRemoveTrack(context))">Remove</MudIconButton>
            </MudTd>
        </RowTemplate>
    </AppTable>

</EditCard>

@code {
    [Inject] public IDialogService DialogService { get; set; }
    [Inject] public IDispatcher Dispatcher { get; set; }
    [Inject] public IState<CurrentTrackState> CurrentTrackState { get; set; }

    [Parameter] public List<AlbumTrackVM> Model { get; set; }

    protected override void OnInitialized()
    {
        SubscribeToAction<TrackRemovedAction>(OnTrackRemoved);
        base.OnInitialized();
    }

    private async Task OnRemoveTrack(AlbumTrackVM track)
    {
        var currentTrackId = CurrentTrackState.Value.Track?.Id;
        if (currentTrackId == track.TrackId)
        {
            Dispatcher.Dispatch(new NotificationErrorRequest("Track cannot be removed while currently playing", null, null));
            return;
        }

        var trackToRemove = new TrackToRemove
        {
            Id = track.TrackId,
            Title = track.Title,
            ArtistName = track.ArtistName
        };

        await DialogService.DisplayForm<RemoveTrack, TrackToRemove>(trackToRemove, "Remove Track", false);
    }

    private void OnTrackRemoved(TrackRemovedAction action)
    {
        var trackOnDisc = Model.SingleOrDefault(t => t.TrackId == action.TrackId);
        if (trackOnDisc == null)
            return;

        Model.Remove(trackOnDisc);
        StateHasChanged();
    }
}
